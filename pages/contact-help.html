<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NunciaYa - Help & Contact</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to the external stylesheet (one level up) -->
    <link rel="stylesheet" href="../style.css">
    <!-- Load Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
</head>

<body class="bg-gray-100 text-gray-900">

    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 max-w-3xl py-8">
        <h2 class="text-3xl font-bold mb-6">
            <span class="lang-en">Help & Contact</span>
            <span class="lang-es">Ayuda y Contacto</span>
        </h2>

        <form id="contact-form" class="bg-white p-6 rounded-md shadow-sm border border-gray-200 space-y-4" novalidate>

            <!-- User Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="contact-name" class="block text-sm font-medium text-gray-700 required-label">
                        <span class="lang-en">Your Name</span>
                        <span class="lang-es">Su Nombre</span>
                    </label>
                    <input type="text" id="contact-name" name="name" required
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="contact-email" class="block text-sm font-medium text-gray-700 required-label">
                        <span class="lang-en">Your Email</span>
                        <span class="lang-es">Su Correo Electrónico</span>
                    </label>
                    <input type="email" id="contact-email" name="email" required
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div>
                <label for="contact-phone" class="block text-sm font-medium text-gray-700">
                    <span class="lang-en">Your Phone (Optional)</span>
                    <span class="lang-es">Su Teléfono (Opcional)</span>
                </label>
                <input type="tel" id="contact-phone" name="phone"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Topic Dropdown -->
            <div class="border-t border-gray-200 pt-4">
                <label for="contact-topic" class="block text-sm font-medium text-gray-700 required-label">
                    <span class="lang-en">What do you need help with?</span>
                    <span class="lang-es">¿Con qué necesita ayuda?</span>
                </label>
                <select id="contact-topic" name="topic" required
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="" disabled selected>
                        <!-- This text will be set by setLang -->
                        <span class="lang-en">-- Please select a topic --</span>
                        <span class="lang-es">-- Por favor seleccione un tema --</span>
                    </option>
                    <option value="profile-change">
                        <span class="lang-en">Change my profile details (name, phone)</span>
                        <span class="lang-es">Cambiar los detalles de mi perfil (nombre, teléfono)</span>
                    </option>
                    <option value="ad-issue">
                        <span class="lang-en">An issue with my ad (editing, deleting)</span>
                        <span class="lang-es">Un problema con mi anuncio (editar, borrar)</span>
                    </option>
                    <option value="report-ad">
                        <span class="lang-en">Report an ad or user</span>
                        <span class="lang-es">Reportar un anuncio o usuario</span>
                    </option>
                    <option value="account-access">
                        <span class="lang-en">Account access issue (password, login)</span>
                        <span class="lang-es">Problema de acceso a mi cuenta (clave, ingreso)</span>
                    </option>
                    <option value="safety-concern">
                        <span class="lang-en">Safety concern</span>
                        <span class="lang-es">Inquietud de seguridad</span>
                    </option>
                    <option value="other">
                        <span class="lang-en">Other...</span>
                        <span class="lang-es">Otro...</span>
                    </option>
                </select>
            </div>

            <!-- "Other" Message Box -->
            <div id="message-box-container" class="hidden">
                <label for="contact-message" class="block text-sm font-medium text-gray-700 required-label">
                    <span class="lang-en">Please describe your issue</span>
                    <span class="lang-es">Por favor describa su problema</span>
                </label>
                <textarea id="contact-message" name="message" rows="5"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <!-- Message Area -->
            <div id="form-message-area" class="text-center text-sm"></div>

            <!-- Submit Button -->
            <div class="pt-4">
                <button type="submit" id="submit-button"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="lang-en">Send Message</span>
                    <span class="lang-es">Enviar Mensaje</span>
                </button>
            </div>

        </form>
    </main>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Main Application Script (CORRECTED PATH) -->
    <script src="../app.js"></script>

    <!-- Page-Specific Script -->
    <script>
        // 1. Page Elements
        const contactForm = document.getElementById('contact-form');
        const contactName = document.getElementById('contact-name');
        const contactEmail = document.getElementById('contact-email');
        const contactPhone = document.getElementById('contact-phone');
        const contactTopic = document.getElementById('contact-topic');
        const messageBoxContainer = document.getElementById('message-box-container');
        const contactMessage = document.getElementById('contact-message');
        const submitButton = document.getElementById('submit-button');
        const formMessageArea = document.getElementById('form-message-area');

        // 2. Page State
        let currentLang = 'es';
        let db;
        let auth;
        let currentUserData = null; // Store user's profile data

        // 3. Page-specific text
        const pageSpecificText = {
            'contact-name': { en: 'Your Name', es: 'Su Nombre' },
            'contact-email': { en: 'Your Email', es: 'Su Correo Electrónico' },
            'contact-phone': { en: 'Your Phone (Optional)', es: 'Su Teléfono (Opcional)' }
            // Dropdown options are handled by the new setLang
        };

        // 4. Language Setup (Corrected Version)
        const originalSetLang = window.setLang;
        window.setLang = (lang) => {
            if (lang) {
                currentLang = lang;
            }
            // Call the global function from app.js first
            if (originalSetLang) {
                originalSetLang(currentLang, pageSpecificText);
            }
            
            // --- Special handling for <select> options ---
            // The global function can't see inside <option> tags
            contactTopic.querySelectorAll('option').forEach(option => {
                const enSpan = option.querySelector('.lang-en');
                const esSpan = option.querySelector('.lang-es');
                
                if (enSpan && esSpan) {
                    // We set the *option's* text content, not the span's
                    if (currentLang === 'es') {
                        option.textContent = esSpan.textContent;
                    } else {
                        option.textContent = enSpan.textContent;
                    }
                }
            });
        };

        // 5. Form Logic
        contactTopic.addEventListener('change', () => {
            if (contactTopic.value === 'other') {
                messageBoxContainer.classList.remove('hidden');
                contactMessage.required = true;
            } else {
                messageBoxContainer.classList.add('hidden');
                contactMessage.required = false;
            }
        });

        function displayFormMessage(message, isError = false) {
            formMessageArea.textContent = message;
            formMessageArea.className = `text-center text-sm my-2 ${isError ? 'text-red-600' : 'text-green-600'}`;
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            if (!contactForm.checkValidity()) {
                const message = currentLang === 'es' ? 'Por favor complete todos los campos requeridos (*).' : 'Please fill out all required fields (*).';
                displayFormMessage(message, true);
                return;
            }

            if (!db) {
                const message = currentLang === 'es' ? 'Error: No se pudo conectar a la base de datos.' : 'Error: Could not connect to the database.';
                displayFormMessage(message, true);
                return;
            }

            submitButton.disabled = true;
            const enMessage = submitButton.querySelector('.lang-en');
            const esMessage = submitButton.querySelector('.lang-es');
            if (enMessage) enMessage.textContent = 'Sending...';
            if (esMessage) esMessage.textContent = 'Enviando...';

            try {
                const formData = new FormData(contactForm);
                const helpRequest = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone') || '',
                    topic: formData.get('topic'),
                    message: formData.get('message') || '',
                    submittedAt: firebase.firestore.Timestamp.now(),
                    status: 'new',
                    userId: auth.currentUser ? auth.currentUser.uid : 'anonymous'
                };

                // Add to Firestore
                await db.collection("help-requests").add(helpRequest);
                
                // Success
                contactForm.reset();
                messageBoxContainer.classList.add('hidden');
                const message = currentLang === 'es' ? '¡Mensaje enviado con éxito! Nos pondremos en contacto pronto.' : 'Message sent successfully! We will be in touch soon.';
                displayFormMessage(message, false);

            } catch (error) {
                console.error("Error submitting help request:", error);
                const message = currentLang === 'es' ? 'Error al enviar el mensaje. Por favor, intente de nuevo.' : 'Error sending message. Please try again.';
                displayFormMessage(message, true);
            } finally {
                submitButton.disabled = false;
                if (enMessage) enMessage.textContent = 'Send Message';
                if (esMessage) esMessage.textContent = 'Enviar Mensaje';
            }
        }

        // 6. Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM Content Loaded for contact-help.html");
            try {
                // 1. Load components (path prefix is '../' for nested page)
                let headerLoaded = false;
                if (window.loadComponents) {
                    headerLoaded = await window.loadComponents('../'); // This path is correct
                    console.log("Components loaded:", headerLoaded);
                } else { throw new Error("loadComponents not found"); }

                // 2. Wait for Firebase instances
                let attempts = 0;
                while ((!window.firebaseAuthInstance || !window.firestoreDbInstance) && !window.firebaseInitializationError && attempts < 20) {
                    console.log(`Waiting for Firebase instances... Attempt ${attempts + 1}`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (window.firebaseAuthInstance && window.firestoreDbInstance) {
                    db = window.firestoreDbInstance;
                    auth = window.firebaseAuthInstance;
                    console.log("Firebase instances assigned.");

                    // 3. Run session logic
                    if (headerLoaded && window.runSessionLogic) {
                        window.runSessionLogic('../');
                    }

                    // 4. Set initial language (will also fix dropdown)
                    if (window.setLang) {
                        window.setLang(currentLang);
                        console.log("Initial language set.");
                    }

                    // 5. Add form submit listener
                    contactForm.addEventListener('submit', handleFormSubmit);

                    // 6. Check auth state to pre-fill form
                    auth.onAuthStateChanged(async (user) => {
                        if (user && !user.isAnonymous) {
                            console.log("User is logged in, fetching profile...");
                            contactEmail.value = user.email || '';
                            // Fetch user data from 'users' collection
                            try {
                                const userDocRef = db.collection("users").doc(user.uid);
                                const docSnap = await userDocRef.get();
                                if (docSnap.exists) {
                                    currentUserData = docSnap.data();
                                    contactName.value = currentUserData.name || '';
                                    contactPhone.value = currentUserData.phone || '';
                                } else {
                                    console.warn("No profile document found for user.");
                                }
                            } catch (error) {
                                console.error("Error fetching user profile data:", error);
                            }
                        } else {
                            console.log("User is anonymous or logged out.");
                        }
                    });

                } else {
                    throw new Error("Firebase instances not available after delay.");
                }

            } catch (error) {
                console.error("Initialization error on contact-help.html:", error);
                displayFormMessage("Error loading page. Please try refreshing.", true);
                if (window.setLang) window.setLang(currentLang);
            }
        });
    </script>

</body>
</html>